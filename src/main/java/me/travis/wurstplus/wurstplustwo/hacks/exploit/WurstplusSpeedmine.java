package me.travis.wurstplus.wurstplustwo.hacks.exploit;

import java.util.List;
import java.util.function.Predicate;
import me.travis.wurstplus.wurstplustwo.event.events.WurstplusEventBlock;
import me.travis.wurstplus.wurstplustwo.event.events.WurstplusEventPacket;
import me.travis.wurstplus.wurstplustwo.guiscreen.settings.WurstplusSetting;
import me.travis.wurstplus.wurstplustwo.hacks.WurstplusCategory;
import me.travis.wurstplus.wurstplustwo.hacks.WurstplusHack;
import me.travis.wurstplus.wurstplustwo.util.WurstplusTimer;
import me.zero.alpine.fork.listener.EventHandler;
import me.zero.alpine.fork.listener.EventHook;
import me.zero.alpine.fork.listener.Listener;
import net.minecraft.block.Block;
import net.minecraft.block.state.IBlockState;
import net.minecraft.client.Minecraft;
import net.minecraft.client.entity.EntityPlayerSP;
import net.minecraft.client.multiplayer.PlayerControllerMP;
import net.minecraft.client.multiplayer.WorldClient;
import net.minecraft.client.network.NetHandlerPlayClient;
import net.minecraft.client.settings.GameSettings;
import net.minecraft.client.settings.KeyBinding;
import net.minecraft.entity.Entity;
import net.minecraft.entity.item.EntityEnderCrystal;
import net.minecraft.init.Blocks;
import net.minecraft.network.Packet;
import net.minecraft.network.play.client.CPacketAnimation;
import net.minecraft.network.play.client.CPacketPlayerDigging;
import net.minecraft.util.EnumFacing;
import net.minecraft.util.EnumHand;
import net.minecraft.util.math.AxisAlignedBB;
import net.minecraft.util.math.BlockPos;
import net.minecraft.world.World;

public class WurstplusSpeedmine
extends WurstplusHack {
    WurstplusSetting mode;
    WurstplusSetting damage;
    WurstplusSetting reset;
    WurstplusSetting no_break_anim;
    WurstplusSetting no_delay;
    WurstplusSetting no_swing;
    WurstplusSetting allow;
    WurstplusSetting double_break;
    private final WurstplusTimer timer;
    private IBlockState current_block_state;
    private BlockPos current_pos;
    private BlockPos last_pos;
    private EnumFacing last_facing;
    private boolean is_mining;
    @EventHandler
    private Listener<WurstplusEventPacket.SendPacket> send_listener;
    @EventHandler
    private Listener<WurstplusEventBlock> block_event;

    public WurstplusSpeedmine() {
        super(WurstplusCategory.WURSTPLUS_EXPLOIT);
        this.mode = this.create("Mode", "SpeedmineMode", "Normal", this.combobox(new String[]{"Normal", "Packet", "Damage", "Instant"}));
        this.damage = this.create("Damage Ammount", "SpeedmineDamagaeAmmount", 0.7, 0.0, 1.0);
        this.reset = this.create("Reset", "SpeedmineReset", true);
        this.no_break_anim = this.create("No Break Anim", "SpeedMineBreakAnim", false);
        this.no_delay = this.create("No Delay", "SpeedmineNoDelay", false);
        this.no_swing = this.create("No Swing", "SpeedmineNoSwing", false);
        this.allow = this.create("MultiTask", "SpeedmineMultiTask", false);
        this.double_break = this.create("Double Break", "SpeedmineDoubleBreak", false);
        this.timer = new WurstplusTimer();
        this.current_block_state = null;
        this.current_pos = null;
        this.last_pos = null;
        this.last_facing = null;
        this.is_mining = false;
        this.send_listener = new Listener(event -> {
            if (this.no_swing.get_value(true) && event.get_packet() instanceof CPacketAnimation) {
                event.cancel();
            }
            if (this.no_break_anim.get_value(true) && event.get_packet() instanceof CPacketPlayerDigging) {
                CPacketPlayerDigging p = (CPacketPlayerDigging)event.get_packet();
                try {
                    for (Entity entity : WurstplusSpeedmine.mc.field_71441_e.func_72839_b(null, new AxisAlignedBB(p.func_179715_a()))) {
                        if (!(entity instanceof EntityEnderCrystal)) continue;
                        this.show_anim();
                        return;
                    }
                }
                catch (Exception exception) {
                    // empty catch block
                }
                if (p.func_180762_c().equals((Object)CPacketPlayerDigging.Action.START_DESTROY_BLOCK)) {
                    this.show_anim(true, p.func_179715_a(), p.func_179714_b());
                }
                if (p.func_180762_c().equals((Object)CPacketPlayerDigging.Action.STOP_DESTROY_BLOCK)) {
                    this.show_anim();
                }
            }
        }
        , new Predicate[0]);
        this.block_event = new Listener(event -> {
            if (event.get_stage() == 3 && this.reset.get_value(true) && WurstplusSpeedmine.mc.field_71442_b.field_78770_f > 0.1f) {
                WurstplusSpeedmine.mc.field_71442_b.field_78778_j = true;
            }
            if (event.get_stage() == 4 && !this.mode.in("Normal")) {
                BlockPos above;
                if (WurstplusSpeedmine.canBreak(event.pos)) {
                    if (this.reset.get_value(true)) {
                        WurstplusSpeedmine.mc.field_71442_b.field_78778_j = false;
                    }
                    if (this.mode.in("Packet")) {
                        if (this.current_pos == null) {
                            this.current_pos = event.pos;
                            this.current_block_state = WurstplusSpeedmine.mc.field_71441_e.func_180495_p(this.current_pos);
                            this.timer.reset();
                        }
                        WurstplusSpeedmine.mc.field_71439_g.func_184609_a(EnumHand.MAIN_HAND);
                        WurstplusSpeedmine.mc.field_71439_g.field_71174_a.func_147297_a((Packet)new CPacketPlayerDigging(CPacketPlayerDigging.Action.START_DESTROY_BLOCK, event.pos, event.facing));
                        WurstplusSpeedmine.mc.field_71439_g.field_71174_a.func_147297_a((Packet)new CPacketPlayerDigging(CPacketPlayerDigging.Action.STOP_DESTROY_BLOCK, event.pos, event.facing));
                        event.cancel();
                    }
                    if (this.mode.in("Damage") && WurstplusSpeedmine.mc.field_71442_b.field_78770_f >= (float)this.damage.get_value(1)) {
                        WurstplusSpeedmine.mc.field_71442_b.field_78770_f = 1.0f;
                    }
                    if (this.mode.in("Instant")) {
                        WurstplusSpeedmine.mc.field_71439_g.func_184609_a(EnumHand.MAIN_HAND);
                        WurstplusSpeedmine.mc.field_71439_g.field_71174_a.func_147297_a((Packet)new CPacketPlayerDigging(CPacketPlayerDigging.Action.START_DESTROY_BLOCK, event.pos, event.facing));
                        WurstplusSpeedmine.mc.field_71439_g.field_71174_a.func_147297_a((Packet)new CPacketPlayerDigging(CPacketPlayerDigging.Action.STOP_DESTROY_BLOCK, event.pos, event.facing));
                        WurstplusSpeedmine.mc.field_71442_b.func_187103_a(event.pos);
                        WurstplusSpeedmine.mc.field_71441_e.func_175698_g(event.pos);
                    }
                }
                if (this.double_break.get_value(true) && WurstplusSpeedmine.canBreak(above = event.pos.func_177984_a()) && WurstplusSpeedmine.mc.field_71439_g.func_70011_f((double)above.func_177958_n(), (double)above.func_177956_o(), (double)above.func_177952_p()) <= 5.0) {
                    WurstplusSpeedmine.mc.field_71439_g.func_184609_a(EnumHand.MAIN_HAND);
                    WurstplusSpeedmine.mc.field_71439_g.field_71174_a.func_147297_a((Packet)new CPacketPlayerDigging(CPacketPlayerDigging.Action.START_DESTROY_BLOCK, above, event.facing));
                    WurstplusSpeedmine.mc.field_71439_g.field_71174_a.func_147297_a((Packet)new CPacketPlayerDigging(CPacketPlayerDigging.Action.STOP_DESTROY_BLOCK, above, event.facing));
                    WurstplusSpeedmine.mc.field_71442_b.func_187103_a(above);
                    WurstplusSpeedmine.mc.field_71441_e.func_175698_g(above);
                }
            }
        }
        , new Predicate[0]);
        this.name = "Speed Mine";
        this.tag = "SpeedMine";
        this.description = "mine faster";
    }

    public void update() {
        if (!(this.current_pos == null || WurstplusSpeedmine.mc.field_71441_e.func_180495_p(this.current_pos).equals((Object)this.current_block_state) && WurstplusSpeedmine.mc.field_71441_e.func_180495_p(this.current_pos).func_177230_c() != Blocks.field_150350_a)) {
            this.current_pos = null;
            this.current_block_state = null;
        }
        if (this.no_delay.get_value(true)) {
            WurstplusSpeedmine.mc.field_71442_b.field_78781_i = 0;
        }
        if (this.is_mining && this.last_pos != null && this.last_facing != null && this.no_break_anim.get_value(true)) {
            WurstplusSpeedmine.mc.field_71439_g.field_71174_a.func_147297_a((Packet)new CPacketPlayerDigging(CPacketPlayerDigging.Action.ABORT_DESTROY_BLOCK, this.last_pos, this.last_facing));
        }
        if (this.reset.get_value(true) && WurstplusSpeedmine.mc.field_71474_y.field_74313_G.func_151470_d() && !this.allow.get_value(true)) {
            WurstplusSpeedmine.mc.field_71442_b.field_78778_j = false;
        }
    }

    public void show_anim(boolean is_mining, BlockPos last_pos, EnumFacing last_facing) {
        this.is_mining = is_mining;
        this.last_pos = last_pos;
        this.last_facing = last_facing;
    }

    public void show_anim() {
        this.show_anim(false, null, null);
    }

    public String array_detail() {
        return this.mode.get_current_value();
    }

    public static boolean canBreak(BlockPos pos) {
        IBlockState blockState = WurstplusSpeedmine.mc.field_71441_e.func_180495_p(pos);
        Block block = blockState.func_177230_c();
        return block.func_176195_g(blockState, (World)WurstplusSpeedmine.mc.field_71441_e, pos) != -1.0f;
    }
}
